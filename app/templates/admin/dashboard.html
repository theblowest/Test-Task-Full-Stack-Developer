{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Админская панель</h2>

    {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h4>Загрузить новый файл</h4>
    <form method="POST" enctype="multipart/form-data" action="{{ url_for('admin_upload_file') }}">
        <div class="mb-3">
            <label for="file" class="form-label">Выберите файл</label>
            <input type="file" class="form-control" name="file" required>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Описание</label>
            <input type="text" class="form-control" name="description" placeholder="Введите описание">
        </div>
        <button type="submit" class="btn btn-success">Загрузить файл</button>
    </form>

    <h4 class="mt-5">Существующие файлы</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Имя файла</th>
                <th>Описание</th>
                <th>Количество загрузок</th>
                <th>Доступность</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="file-list">
            {% for file in files %}
                <tr id="file-{{ file.id }}">
                    <td>{{ file.name }}</td>
                    <td>{{ file.description }}</td>
                    <td>{{ file.download_count }}
                        <span class="downloads">({{ file.downloads }} скачиваний)</span>
                    </td>
                    <td>
                        {% if file.accessible_to_users %}
                            <span class="badge bg-success">Доступен</span>
                        {% else %}
                            <span class="badge bg-danger">Недоступен</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" class="d-inline" id="toggle-availability-form-{{ file.id }}">
                            <input type="hidden" name="file_id" value="{{ file.id }}">
                            <button type="submit" name="action" value="toggle_availability" class="btn btn-info">
                                {% if file.accessible_to_users %}
                                    Скрыть
                                {% else %}
                                    Разрешить
                                {% endif %}
                            </button>
                        </form>
                        <a href="{{ url_for('admin_download_file', file_id=file.id) }}" class="btn btn-primary">Скачать</a>
                        <button type="button" class="btn btn-danger" id="delete-file-{{ file.id }}" data-file-id="{{ file.id }}" onclick="deleteFile(this)">Удалить</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function deleteFile(buttonElement) {
        const fileId = buttonElement.getAttribute('data-file-id');  // Получаем file_id из атрибута
    
        if (confirm('Вы уверены, что хотите удалить этот файл?')) {
            // Отправляем запрос на удаление
            fetch('/admin/delete/' + fileId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'file_id': fileId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Удаляем строку из таблицы
                    const fileRow = document.getElementById('file-' + fileId);
                    fileRow.remove();
                } else {
                    alert('Ошибка при удалении файла.');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
            });
        }
    }    
</script>
{% endblock %}
